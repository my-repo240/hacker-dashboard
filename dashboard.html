<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Business CRM with Registration and Edit/Delete</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: Arial, sans-serif; margin:0; padding:0; background: #f5f5f5; }
    header { background: #1565c0; color: #fff; padding: 20px; text-align: center; }
    .nav { background: #1976d2; padding: 10px; }
    .nav a { color: #fff; margin: 0 10px; text-decoration: none; cursor: pointer; }
    .content { padding: 20px; }
    .hidden { display: none; }
    button { padding: 8px 15px; cursor: pointer; border: none; background: #1976d2; color: white; border-radius: 4px; }
    input, select { padding: 6px; margin: 6px 0; width: 100%; max-width: 300px; box-sizing: border-box; }
    ul { list-style-type: none; padding: 0; }
    li { background: white; margin-bottom: 10px; padding: 10px; border-radius: 4px; display: flex; justify-content: space-between; align-items: center; }
    .task-buttons button { margin-left: 8px; background: #4caf50; }
    .task-buttons button.delete { background: #f44336; }
    #message { margin: 10px 0; color: green; }
    #error { margin: 10px 0; color: red; }
  </style>
</head>
<body>

<header>
  <h1>Business CRM</h1>
  <div id="userInfo"></div>
  <button id="logoutBtn" class="hidden">Logout</button>
</header>

<div class="nav hidden" id="navBar">
  <a data-section="dashboard">Dashboard</a>
  <a data-section="tasks">Tasks</a>
  <a data-section="settings">Settings</a>
</div>

<div class="content">
  <!-- LOGIN & REGISTER -->
  <div id="authSection">
    <div id="loginSection">
      <h2>Login</h2>
      <input type="email" id="loginEmail" placeholder="Email" />
      <input type="password" id="loginPassword" placeholder="Password" />
      <button id="loginBtn">Login</button>
      <p>Don't have an account? <a href="#" id="showRegister">Register here</a></p>
    </div>

    <div id="registerSection" class="hidden">
      <h2>Register</h2>
      <input type="email" id="registerEmail" placeholder="Email" />
      <input type="password" id="registerPassword" placeholder="Password (6+ chars)" />
      <button id="registerBtn">Register</button>
      <p>Already have an account? <a href="#" id="showLogin">Login here</a></p>
    </div>
  </div>

  <div id="dashboard" class="hidden">
    <h2>Dashboard Home</h2>
    <p>Welcome to your CRM Dashboard!</p>
  </div>

  <div id="tasks" class="hidden">
    <h2>Tasks</h2>
    <button id="newTaskBtn">+ Add Task</button>
    <ul id="taskList"></ul>

    <div id="taskFormDiv" class="hidden">
      <h3 id="taskFormTitle">Add New Task</h3>
      <input type="text" id="taskName" placeholder="Task Name" />
      <select id="taskStatus">
        <option value="">Select Status</option>
        <option>Not Started</option>
        <option>In Progress</option>
        <option>Completed</option>
      </select>
      <button id="saveTaskBtn">Save Task</button>
      <button id="cancelTaskBtn">Cancel</button>
    </div>
  </div>

  <div id="settings" class="hidden">
    <h2>Settings</h2>
    <p>Account and app settings will go here.</p>
  </div>

  <div id="message"></div>
  <div id="error"></div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { 
    getAuth, 
    onAuthStateChanged, 
    signInWithEmailAndPassword, 
    signOut, 
    createUserWithEmailAndPassword 
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { 
    getFirestore, 
    collection, 
    addDoc, 
    getDocs, 
    deleteDoc, 
    doc,
    updateDoc 
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  // Your Firebase config here
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_PROJECT_ID.appspot.com",
    messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
    appId: "YOUR_APP_ID"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // Elements
  const loginSection = document.getElementById("loginSection");
  const registerSection = document.getElementById("registerSection");
  const authSection = document.getElementById("authSection");
  const dashboard = document.getElementById("dashboard");
  const tasksSection = document.getElementById("tasks");
  const settingsSection = document.getElementById("settings");
  const navBar = document.getElementById("navBar");
  const userInfo = document.getElementById("userInfo");
  const logoutBtn = document.getElementById("logoutBtn");

  const taskList = document.getElementById("taskList");
  const newTaskBtn = document.getElementById("newTaskBtn");
  const taskFormDiv = document.getElementById("taskFormDiv");
  const saveTaskBtn = document.getElementById("saveTaskBtn");
  const cancelTaskBtn = document.getElementById("cancelTaskBtn");
  const taskNameInput = document.getElementById("taskName");
  const taskStatusSelect = document.getElementById("taskStatus");
  const taskFormTitle = document.getElementById("taskFormTitle");

  const loginEmail = document.getElementById("loginEmail");
  const loginPassword = document.getElementById("loginPassword");
  const loginBtn = document.getElementById("loginBtn");

  const registerEmail = document.getElementById("registerEmail");
  const registerPassword = document.getElementById("registerPassword");
  const registerBtn = document.getElementById("registerBtn");

  const showRegisterLink = document.getElementById("showRegister");
  const showLoginLink = document.getElementById("showLogin");

  const messageDiv = document.getElementById("message");
  const errorDiv = document.getElementById("error");

  let editingTaskId = null;

  // Show/hide register/login forms
  showRegisterLink.addEventListener("click", e => {
    e.preventDefault();
    loginSection.classList.add("hidden");
    registerSection.classList.remove("hidden");
    clearMessages();
  });
  showLoginLink.addEventListener("click", e => {
    e.preventDefault();
    registerSection.classList.add("hidden");
    loginSection.classList.remove("hidden");
    clearMessages();
  });

  // Register
  registerBtn.addEventListener("click", async () => {
    clearMessages();
    const email = registerEmail.value.trim();
    const password = registerPassword.value;

    if (!email || !password || password.length < 6) {
      showError("Please enter valid email and password (6+ chars).");
      return;
    }
    try {
      await createUserWithEmailAndPassword(auth, email, password);
      showMessage("Registration successful! You are now logged in.");
    } catch (e) {
      showError(e.message);
    }
  });

  // Login
  loginBtn.addEventListener("click", async () => {
    clearMessages();
    const email = loginEmail.value.trim();
    const password = loginPassword.value;
    if (!email || !password) {
      showError("Please enter email and password.");
      return;
    }
    try {
      await signInWithEmailAndPassword(auth, email, password);
    } catch (e) {
      showError("Login failed: " + e.message);
    }
  });

  // Logout
  logoutBtn.addEventListener("click", () => {
    signOut(auth);
  });

  // Monitor auth state
  onAuthStateChanged(auth, user => {
    clearMessages();
    if (user) {
      authSection.classList.add("hidden");
      navBar.classList.remove("hidden");
      logoutBtn.classList.remove("hidden");
      userInfo.textContent = `Logged in as: ${user.email}`;
      showSection("dashboard");
      loadTasks();
    } else {
      authSection.classList.remove("hidden");
      navBar.classList.add("hidden");
      logoutBtn.classList.add("hidden");
      userInfo.textContent = "";
      hideAllSections();
    }
  });

  // Navigation links
  navBar.querySelectorAll("a").forEach(link => {
    link.addEventListener("click", () => {
      clearMessages();
      showSection(link.dataset.section);
      if (link.dataset.section === "tasks") loadTasks();
    });
  });

  function showSection(section) {
    [dashboard, tasksSection, settingsSection].forEach(sec => sec.classList.add("hidden"));
    if (section === "dashboard") dashboard.classList.remove("hidden");
    else if (section === "tasks") tasksSection.classList.remove("hidden");
    else if (section === "settings") settingsSection.classList.remove("hidden");
    taskFormDiv.classList.add("hidden");
    newTaskBtn.disabled = false;
  }

  function hideAllSections() {
    [dashboard, tasksSection, settingsSection].forEach(sec => sec.classList.add("hidden"));
    taskFormDiv.classList.add("hidden");
    newTaskBtn.disabled = false;
  }

  // Task form show/hide for add/edit
  newTaskBtn.addEventListener("click", () => {
    editingTaskId = null;
    taskFormTitle.textContent = "Add New Task";
    taskNameInput.value = "";
    taskStatusSelect.value = "";
    taskFormDiv.classList.remove("hidden");
    newTaskBtn.disabled = true;
    clearMessages();
  });

  cancelTaskBtn.addEventListener("click", () => {
    taskFormDiv.classList.add("hidden");
    newTaskBtn.disabled = false;
    clearMessages();
  });

  saveTaskBtn.addEventListener("click", async () => {
    clearMessages();
    const name = taskNameInput.value.trim();
    const status = taskStatusSelect.value;
    if (!name || !status) {
      showError("Please fill all task details.");
      return;
    }
    try {
      if (editingTaskId) {
        // Update existing task
        const taskDocRef = doc(db, "tasks", editingTaskId);
        await updateDoc(taskDocRef, { name, status });
        showMessage("Task updated!");
      } else {
        // Add new task
        await addDoc(collection(db, "tasks"), { name, status, createdAt: new Date() });
        showMessage("Task saved!");
      }
      taskFormDiv.classList.add("hidden");
      newTaskBtn.disabled = false;
      loadTasks();
    } catch (e) {
      showError("Error saving task: " + e.message);
    }
  });

  // Load tasks from Firestore
  async function loadTasks() {
    taskList.innerHTML = "";
    try {
      const snapshot = await getDocs(collection(db, "tasks"));
      if (snapshot.empty) {
        taskList.innerHTML = "<li>No tasks yet.</li>";
      } else {
        snapshot.forEach(docSnap => {
          const task = docSnap.data();
          const id = docSnap.id;

          const li = document.createElement("li");
          const taskText = document.createElement("span");
          taskText.textContent = `${task.name} - ${task.status}`;
          li.appendChild(taskText);

          // Buttons container
          const btnsDiv = document.createElement("div");
          btnsDiv.classList.add("task-buttons");

          // Edit button
          const editBtn = document.createElement("button");
          editBtn.textContent = "Edit";
          editBtn.addEventListener("click", () => editTask(id, task));
          btnsDiv.appendChild(editBtn);

          // Delete button
          const deleteBtn = document.createElement("button");
          deleteBtn.textContent = "Delete";
          deleteBtn.classList.add("delete");
          deleteBtn.addEventListener("click", () => deleteTask(id));
          btnsDiv.appendChild(deleteBtn);

          li.appendChild(btnsDiv);

          taskList.appendChild(li);
        });
      }
    } catch (e) {
      taskList.innerHTML = "<li>Error loading tasks.</li>";
      console.error(e);
    }
  }

  // Edit task
  function editTask(id, task) {
    editingTaskId = id;
    taskFormTitle.textContent = "Edit Task";
    taskNameInput.value = task.name;
    taskStatusSelect.value = task.status;
    taskFormDiv.classList.remove("hidden");
    newTaskBtn.disabled = true;
    clearMessages();
  }

  // Delete task
  async function deleteTask(id) {
    clearMessages();
    if (confirm("Are you sure you want to delete this task?")) {
      try {
        await deleteDoc(doc(db, "tasks", id));
        showMessage("Task deleted.");
        loadTasks();
      } catch (e) {
        showError("Error deleting task: " + e.message);
      }
    }
  }

  // Message helpers
  function showMessage(msg) {
    messageDiv.textContent = msg;
    errorDiv.textContent = "";
  }
  function showError(msg) {
    errorDiv.textContent = msg;
    messageDiv.textContent = "";
  }
  function clearMessages() {
    messageDiv.textContent = "";
    errorDiv.textContent = "";
  }
</script>

</body>
</html>
